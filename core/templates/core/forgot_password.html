{% extends 'core/base_public.html' %}

{% block title %}Mot de passe oublié - Mission Manager{% endblock %}

{% block content %}
<div class="auth-header">
    <h1><i class="fas fa-key"></i> Mot de passe oublié</h1>
    <p>Réinitialisez votre mot de passe en quelques étapes simples</p>
</div>

<!-- Indicateur d'étapes -->
<div class="step-indicator">
    <div class="step {% if step == 'username' %}active{% elif step != 'username' %}completed{% endif %}">1</div>
    <div class="step {% if step == 'confirm_email' %}active{% elif step == 'verify_code' or step == 'new_password' %}completed{% endif %}">2</div>
    <div class="step {% if step == 'verify_code' %}active{% elif step == 'new_password' %}completed{% endif %}">3</div>
    <div class="step {% if step == 'new_password' %}active{% endif %}">4</div>
</div>

<!-- Messages d'erreur et de succès -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
{% endif %}

<!-- Étape 1: Saisie du nom d'utilisateur -->
{% if step == 'username' %}
<form method="post" class="needs-validation" novalidate>
    {% csrf_token %}
    <input type="hidden" name="step" value="username">
    
    <div class="mb-3">
        <label for="username" class="form-label">
            <i class="fas fa-user"></i> Nom d'utilisateur
        </label>
        <input type="text" 
               class="form-control" 
               id="username" 
               name="username" 
               value="{{ username|default:'' }}"
               placeholder="Entrez votre nom d'utilisateur"
               required>
        <div class="invalid-feedback">
            Veuillez saisir votre nom d'utilisateur.
        </div>
    </div>
    
    <div class="d-grid">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-search"></i> Continuer
        </button>
    </div>
</form>
{% endif %}

<!-- Étape 2: Confirmation de l'email -->
{% if step == 'confirm_email' %}
<div class="text-center mb-4">
    <div class="alert alert-info">
        <i class="fas fa-envelope"></i>
        <strong>Email trouvé :</strong> {{ masked_email }}
    </div>
</div>

<form method="post" class="needs-validation" novalidate>
    {% csrf_token %}
    <input type="hidden" name="step" value="confirm_email">
    
    <div class="mb-3">
        <p class="text-muted">
            Un code de réinitialisation sera envoyé à cette adresse email.
            Le code expirera dans 15 minutes.
        </p>
    </div>
    
    <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Envoyer le code
        </button>
        <a href="{% url 'forgot_password' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour
        </a>
    </div>
</form>
{% endif %}

<!-- Étape 3: Vérification du code -->
{% if step == 'verify_code' %}
<div class="text-center mb-4">
    <div class="alert alert-success">
        <i class="fas fa-check-circle"></i>
        Code envoyé à {{ masked_email }}
    </div>
</div>

<form method="post" class="needs-validation" novalidate>
    {% csrf_token %}
    <input type="hidden" name="step" value="verify_code">
    
    <div class="mb-3">
        <label for="code" class="form-label">
            <i class="fas fa-shield-alt"></i> Code de vérification
        </label>
        <input type="text" 
               class="form-control code-input" 
               id="code" 
               name="code" 
               placeholder="000000"
               maxlength="6"
               pattern="[0-9]{6}"
               required>
        <div class="form-text">
            Entrez le code à 6 chiffres reçu par email
        </div>
        <div class="invalid-feedback">
            Veuillez saisir le code à 6 chiffres.
        </div>
    </div>
    
    <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-check"></i> Vérifier le code
        </button>
        <a href="{% url 'forgot_password' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour
        </a>
    </div>
</form>
{% endif %}

<!-- Étape 4: Nouveau mot de passe -->
{% if step == 'new_password' %}
<div class="text-center mb-4">
    <div class="alert alert-success">
        <i class="fas fa-check-circle"></i>
        Code vérifié avec succès !
    </div>
</div>

<form method="post" class="needs-validation" novalidate>
    {% csrf_token %}
    <input type="hidden" name="step" value="new_password">
    
    <div class="mb-3">
        <label for="password1" class="form-label">
            <i class="fas fa-lock"></i> Nouveau mot de passe
        </label>
        <input type="password" 
               class="form-control" 
               id="password1" 
               name="password1" 
               placeholder="Nouveau mot de passe"
               minlength="8"
               required>
        <div class="form-text">
            Le mot de passe doit contenir au moins 8 caractères
        </div>
        <div class="invalid-feedback">
            Veuillez saisir un mot de passe d'au moins 8 caractères.
        </div>
    </div>
    
    <div class="mb-3">
        <label for="password2" class="form-label">
            <i class="fas fa-lock"></i> Confirmer le mot de passe
        </label>
        <input type="password" 
               class="form-control" 
               id="password2" 
               name="password2" 
               placeholder="Confirmer le mot de passe"
               required>
        <div class="invalid-feedback">
            Les mots de passe ne correspondent pas.
        </div>
    </div>
    
    <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Réinitialiser le mot de passe
        </button>
        <a href="{% url 'forgot_password' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour
        </a>
    </div>
</form>
{% endif %}

<div class="auth-footer">
    <p>Vous vous souvenez de votre mot de passe ? 
        <a href="{% url 'connexion' %}">Se connecter</a>
    </p>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Validation des formulaires
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Auto-focus sur le champ de code
document.addEventListener('DOMContentLoaded', function() {
    var codeInput = document.getElementById('code');
    if (codeInput) {
        codeInput.focus();
        // Auto-formatage du code
        codeInput.addEventListener('input', function(e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length > 6) {
                value = value.substring(0, 6);
            }
            e.target.value = value;
        });
    }
});

// Validation en temps réel des mots de passe
document.addEventListener('DOMContentLoaded', function() {
    var password1 = document.getElementById('password1');
    var password2 = document.getElementById('password2');
    
    if (password1 && password2) {
        function validatePasswords() {
            if (password1.value && password2.value) {
                if (password1.value !== password2.value) {
                    password2.setCustomValidity('Les mots de passe ne correspondent pas');
                } else {
                    password2.setCustomValidity('');
                }
            }
        }
        
        password1.addEventListener('input', validatePasswords);
        password2.addEventListener('input', validatePasswords);
    }
});
</script>
{% endblock %} 